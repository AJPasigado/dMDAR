{% extends 'base.html' %}

{% block title %}
Catalog | Moby Reviews
{% endblock title %}

{% block nav-type %}nav-bar-normal{% endblock nav-type %}

{% block custom-nav %}
    {% if user_logged %} 
        nav-login-hide
    {% else %}
        nav-account-hide
    {% endif %}
{% endblock custom-nav %}

{% block home-active %}{% endblock home-active %}

{% block catalog-active %}active-tab{% endblock catalog-active %}

{% block body %}
<div class="row details-content-margin">
    <div class="row w-100 container-margin-top">
        <!-- <h2 class="mt-5 mb-5 font-weight-light"> <span class="font-weight-bold">Search results for </span>
                    Harry Potter </h2>  -->
        <h2 class="mt-5 font-weight-light"> All Movies </h2>
    </div>

    <div class="row w-100 mb-5 mt-2">
        <div class="w-100 mt-3 rounded pt-4 pb-0 pl-5" id="collapseFilters">
            <div class="row">
                <div class="col-lg pt-2 pb-2">
                    <div class="row">
                        <div class="col-sm-3 pt-1">
                            Ratings:
                        </div>
                        <div class="col-sm-6 pt-1">
                            <span class="" id="rating-slider">
                                <input id="range-2-1" type="range" min="0" max="100" value="30">
                                <input id="range-2-2" type="range" min="0" max="100" value="30">
                                <input type="hidden" id="min-star-filter" name="min">
                                <input type="hidden" id="max-star-filter" name="max">
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-lg pt-1 pb-2">
                    <div class="row">
                        <div class="col-sm-3 pt-2">
                            Genre:
                        </div>
                        <div class="col-sm-6 pt-1">
                            <span class="dropdown">
                                <button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuButton"
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="genre-count">
                                    0 selected
                                </button>
                                <div class="dropdown-menu p-3" aria-labelledby="dropdownMenuButton" id="results">
                                    {% for genre in genres %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="{{ genre.name }}" value="{{ genre.value }}" id="genre-{{ genre.name }}">
                                            <label class="form-check-label" for="genre-{{ genre.name }}">
                                                {{ genre.value }}
                                            </label>
                                        </div>
                                    {% endfor %}
                                </div>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-lg pt-1 pb-2">
                    <div class="row">
                        <div class="col-sm-3 pt-2">
                            Sort By:
                        </div>
                        <div class="col-sm-6 pt-1">
                            <select class="btn btn-light " id="drop-sort" name="sort">
                                <option value="az" selected>Alphabetical</option>
                                <option value="review__rating__avg">Highest Rates</option>
                                <option value="time_posted">Newest</option>
                            </select>
                            <span>
                                <input type="hidden" id="sort">
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-lg pt-2 pb-4">
                    <div class="row">
                        <div class="col-sm-3 pt-1">
                            Show:
                        </div>
                        <div class="col-sm-6 pt-0">
                            <select class="btn btn-light mr-2" id="drop-show" name="show">
                                <option value="16" selected>16</option>
                                <option value="32">32</option>
                                <option value="64">64</option>
                            </select>
                            results
                            <span>
                                <input type="hidden" id="num-results">
                            </span>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>


    <div class="row mb-5 w-100" id="catalog-movies">
        {% for movie in movies %}
            <div class="col-lg details-related-col">
                <a href="{% url 'mobi:details' movie.id %}">
                    <div class="row">
                        <span class="details-related-col-badge">{{ movie.review__rating__avg|floatformat:"1" }} / 5.0 </span>
                        <img src="{{ movie.poster.url }}" class="details-related-img">
                    </div>
                    <div class="row mt-3 details-related-text">
                        <p class="text-uppercase font-weight-bold w-100 text-center mb-1"> {{ movie.title }} <span class="font-weight-light"> ({{ movie.release_date.year }}) </span> </p>
                    </div>
                </a>
            </div>
        {% endfor %}
    </div>
</div>


<div class="row details-content-margin mb-5">
    <nav class="w-100">
        <ul class="pagination justify-content-center">
            <li class="page-item disabled">
                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
            </li>
            <li class="page-item"><a class="page-link" href="#">1</a></li>
            <li class="page-item active"><a class="page-link" href="#">2</a></li>
            <li class="page-item"><a class="page-link" href="#">3</a></li>
            <li class="page-item">
                <a class="page-link" href="#">Next</a>
            </li>
        </ul>
    </nav>
</div>

{% block scripts %}
    <script>
        // filter catalogs page
        var filterTimer;
        var filterInterval = 500;
        $('#drop-sort, #drop-show').change(function() {
            clearTimeout(filterTimer);
            filterTimer = setTimeout(filter, filterInterval);
        });

        $(document).on('change', 'input[id^="genre"]', function() {
            clearTimeout(filterTimer);
            filterTimer = setTimeout(filter, filterInterval);
            $('#genre-count').html($('input[id^="genre"]').size()+' selected');
        });

        function filter() {
            var data_serialized = $('input[id$="star-filter"], input[id^="genre"]:checked, select[id^="drop"]').serialize();
            console.log(data_serialized);
            $.ajax({
                headers: {"X-CSRFToken" : '{{ csrf_token }}'},
                type: 'POST',
                url: '{% url "mobi:catalog" %}',
                data: data_serialized,
                dataType: 'json',
                success: function(data) {
                    $('#catalog-movies').html(data.catalog_template);
                }
            })
        }
    </script>
{% endblock %}

{% endblock body %}